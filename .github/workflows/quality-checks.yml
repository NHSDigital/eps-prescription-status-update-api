name: Quality Checks (Optimized)

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: false
    inputs:
      install_java:
        type: boolean
        description: "If true, the action will install java into the runner, separately from ASDF."
        default: false
        required: false
      run_sonar:
        type: boolean
        description: Toggle to run sonar code analyis on this repository.
        default: true
        required: false
      asdfVersion:
        type: string
        required: true
      reinstall_poetry:
        type: boolean
        description: Toggle to reinstall poetry on top of python version installed by asdf.
        default: false

jobs:
  # Fast checks that don't need full environment setup (runs in ~1-2 minutes)
  fast-checks:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "base=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: actionlint
        uses: raven-actions/actionlint@3a24062651993d40fed1019b58ac6fbdfbf276cc

      # - name: Get changed shell scripts
      #   id: changed-shell
      #   run: |
      #     if [ "${{ steps.changed-files.outputs.base }}" != "0000000000000000000000000000000000000000" ]; then
      #       CHANGED_SH=$(git diff --name-only "${{ steps.changed-files.outputs.base }}..${{ steps.changed-files.outputs.head }}" | grep '\.sh$' || true)
      #       if [ -n "$CHANGED_SH" ]; then
      #         echo "files<<EOF" >> "$GITHUB_OUTPUT"
      #         echo "$CHANGED_SH" >> "$GITHUB_OUTPUT"
      #         echo "EOF" >> "$GITHUB_OUTPUT"
      #         echo "has_changes=true" >> "$GITHUB_OUTPUT"
      #       else
      #         echo "has_changes=false" >> "$GITHUB_OUTPUT"
      #       fi
      #     else
      #       # Initial commit or no valid base - check all files
      #       echo "has_changes=true" >> "$GITHUB_OUTPUT"
      #     fi

      - name: Run ShellCheck on changed files
        # if: steps.changed-shell.outputs.has_changes == 'true'
        uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38
        with:
          ignore_paths: >-
            *test*
            .venv
            node_modules
            .git

  # Secret scanning - critical security check (runs in ~2-3 minutes)
  secrets-scan:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Ensure .gitallowed exists
        run: |
          if [ ! -f ".gitallowed" ]; then
            echo "Creating empty .gitallowed file"
            touch .gitallowed
          fi
          echo "./nhsd-rules-deny.txt:10" >> .gitallowed

      - name: Install git-secrets
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl
          git clone https://github.com/awslabs/git-secrets.git /tmp/git-secrets
          cd /tmp/git-secrets
          sudo make install

      - name: Download regex patterns
        run: |
          curl -L https://raw.githubusercontent.com/NHSDigital/software-engineering-quality-framework/main/tools/nhsd-git-secrets/nhsd-rules-deny.txt -o nhsd-rules-deny.txt

      - name: Configure git-secrets
        run: |
          git-secrets --register-aws
          git-secrets --add-provider -- cat nhsd-rules-deny.txt

      - name: Run secrets scan
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, scan only changed files for faster execution
            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | xargs -r git-secrets --scan || git-secrets --scan-history .
          else
            # For other events, scan full history
            git-secrets --scan-history .
          fi

  # License and lint checks requiring full environment (runs in ~3-5 minutes)
  lint-and-licenses:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Install asdf
        uses: asdf-vm/actions/setup@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}

      - name: Cache asdf
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.asdf
          key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}
          restore-keys: |
            ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}

      - name: Install asdf dependencies
        uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}
        env:
          PYTHON_CONFIGURE_OPTS: --enable-shared

      - name: Reinstall poetry
        if: ${{ inputs.reinstall_poetry }}
        run: |
          poetry_tool_version=$(grep poetry .tool-versions)
          poetry_version=${poetry_tool_version//"poetry "}
          asdf uninstall poetry "$poetry_version"
          asdf install poetry

      - name: Setting up .npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          echo "@nhsdigital:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: make install
        run: make install

      - name: Check licenses
        run: make check-licenses

      - name: Run code lint
        run: make lint

      - name: Generate and check SBOMs
        uses: NHSDigital/eps-action-sbom@ae6916d542c092ec1636f9a0ba14464ba25a97d1

  # Unit tests (runs in ~2-5 minutes depending on test suite)
  unit-tests:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Install asdf
        uses: asdf-vm/actions/setup@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}

      - name: Cache asdf
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.asdf
          key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}
          restore-keys: |
            ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}

      - name: Install asdf dependencies
        uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}
        env:
          PYTHON_CONFIGURE_OPTS: --enable-shared

      - name: Reinstall poetry
        if: ${{ inputs.reinstall_poetry }}
        run: |
          poetry_tool_version=$(grep poetry .tool-versions)
          poetry_version=${poetry_tool_version//"poetry "}
          asdf uninstall poetry "$poetry_version"
          asdf install poetry

      - name: Setting up .npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          echo "@nhsdigital:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: make install
        run: make install

      - name: Run unit tests
        run: make test

  # CloudFormation validation (runs only if templates exist, ~3-5 minutes)
  cloudformation-validation:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Check for templates
        id: check_cf
        run: |
          if [ -d "cloudformation" ]; then
            echo "cf_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "cf_exists=false" >> "$GITHUB_OUTPUT"
          fi



          # CF_EXISTS=false; [ -d "cloudformation" ] && CF_EXISTS=true; echo "cf_exists=$CF_EXISTS" >> "$GITHUB_OUTPUT";
          #  SAM_EXISTS=false
          #  [ -d "SAMtemplates" ] && SAM_EXISTS=true
          #  echo "sam_exists=$SAM_EXISTS" >> "$GITHUB_OUTPUT"
          #echo "has_templates=$([[ "$SAM_EXISTS" == "true" || "$CF_EXISTS" == "true" ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      # - name: Get changed CloudFormation files
      #   # if: steps.check_templates.outputs.has_templates == 'true'
      #   id: changed-cf
      #   run: |
      #     if [ "${{ github.event_name }}" = "pull_request" ]; then
      #       CHANGED_CF=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E '^(SAMtemplates|cloudformation)/.*\.y.*ml$' || true)
      #       if [ -n "$CHANGED_CF" ]; then
      #         echo "has_changes=true" >> "$GITHUB_OUTPUT"
      #         echo "$CHANGED_CF"
      #       else
      #         echo "has_changes=false" >> "$GITHUB_OUTPUT"
      #       fi
      #     else
      #       echo "has_changes=true" >> "$GITHUB_OUTPUT"
      #     fi

      - name: Install dependencies
        # if: steps.check_templates.outputs.has_templates == 'true'
        run: |
          pip install cfn-lint
          pip install aws-sam-cli

      - name: Run cfn-lint on changed files
        if: steps.check_cf.outputs.cf_exists == 'true' # && steps.changed-cf.outputs.has_changes == 'true'
        run: |
          cfn-lint -I "cloudformation/**/*.y*ml" 2>&1 | awk '/Run scan/ { print } /^[EW][0-9]/ { print; getline; print }'
          # cfn-lint -I "SAMtemplates/**/*.y*ml" 2>&1 | awk '/Run scan/ { print } /^[EW][0-9]/ { print; getline; print }'

      - name: Init cfn-guard
        if: steps.check_cf.outputs.cf_exists == 'true'
        run: |
          rm -rf /tmp/ruleset cfn_guard_output
          wget -q -O /tmp/ruleset.zip https://github.com/aws-cloudformation/aws-guard-rules-registry/releases/download/1.0.2/ruleset-build-v1.0.2.zip
          unzip -q /tmp/ruleset.zip -d /tmp/ruleset/
          curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/aws-cloudformation/cloudformation-guard/main/install-guard.sh | sh
          mkdir -p cfn_guard_output

      # Run cfn-guard checks in parallel using matrix strategy
      # - name: Run cfn-guard for SAM templates
      #   # if: steps.check_templates.outputs.sam_exists == 'true' && steps.changed-cf.outputs.has_changes == 'true'
      #   run: |
      #     declare -a rulesets=("ncsc" "ncsc-cafv3" "wa-Reliability-Pillar" "wa-Security-Pillar")
      #     for ruleset in "${rulesets[@]}"; do
      #       while IFS= read -r -d '' file; do
      #         mkdir -p "$(dirname cfn_guard_output/"$file")"
      #         SAM_OUTPUT=$(sam validate -t "$file" --region eu-west-2 --debug 2>&1 | grep -Pazo '(?s)AWSTemplateFormatVersion.*\n\/' | tr -d '\0')
      #         echo "${SAM_OUTPUT::-1}" | ~/.guard/bin/cfn-guard validate \
      #             --rules "/tmp/ruleset/output/$ruleset.guard" \
      #             --show-summary fail \
      #             > "cfn_guard_output/${file}_${ruleset}.txt"
      #       done < <(find ./SAMtemplates -name '*.y*ml' -print0)
      #     done

      - name: Run cfn-guard for CloudFormation templates
        if: steps.check_cf.outputs.cf_exists == 'true' # && steps.changed-cf.outputs.has_changes == 'true'
        run: |
          declare -a rulesets=("ncsc" "ncsc-cafv3" "wa-Reliability-Pillar" "wa-Security-Pillar")
          for ruleset in "${rulesets[@]}"; do
            ~/.guard/bin/cfn-guard validate \
                --data cloudformation \
                --rules "/tmp/ruleset/output/$ruleset.guard" \
                --show-summary fail \
                > "cfn_guard_output/cloudformation_$ruleset.txt"
          done

      - name: Show cfn-guard output
        if: failure()
        run: find cfn_guard_output -type f -print0 | xargs -0 cat

      - name: Upload cfn_guard_output
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: cfn_guard_output
          path: cfn_guard_output

  # CDK validation (runs only if CDK exists, ~3-5 minutes)
  cdk-validation:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Check for CDK
        id: check_cdk
        run: |
          if [ -d "packages/cdk" ]; then
            echo "cdk_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "cdk_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install asdf
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        uses: asdf-vm/actions/setup@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}

      - name: Cache asdf
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.asdf
          key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}
          restore-keys: |
            ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}

      - name: Install asdf dependencies
        id: install_asdf
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}
        env:
          PYTHON_CONFIGURE_OPTS: --enable-shared

      - name: Setting up .npmrc
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          echo "@nhsdigital:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: make install
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        run: make install

      - name: Run cdk-synth
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        run: make cdk-synth

      - name: Init cfn-guard
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        run: |
          rm -rf /tmp/ruleset cfn_guard_output
          wget -q -O /tmp/ruleset.zip https://github.com/aws-cloudformation/aws-guard-rules-registry/releases/download/1.0.2/ruleset-build-v1.0.2.zip
          unzip -q /tmp/ruleset.zip -d /tmp/ruleset/
          curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/aws-cloudformation/cloudformation-guard/main/install-guard.sh | sh
          mkdir -p cfn_guard_output

      - name: Run cfn-guard for CDK
        if: steps.check_cdk.outputs.cdk_exists == 'true'
        run: |
          declare -a rulesets=("ncsc" "ncsc-cafv3" "wa-Reliability-Pillar" "wa-Security-Pillar")
          for ruleset in "${rulesets[@]}"; do
            ~/.guard/bin/cfn-guard validate \
                --data cdk.out \
                --rules "/tmp/ruleset/output/$ruleset.guard" \
                --show-summary fail \
                > "cfn_guard_output/cdk.out_$ruleset.txt"
          done

      - name: Show cfn-guard output
        if: failure()
        run: find cfn_guard_output -type f -print0 | xargs -0 cat

      - name: Upload cfn_guard_output
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: cfn_guard_output_cdk
          path: cfn_guard_output

  # Terraform validation (runs only if terraform plans exist, ~2-3 minutes)
  terraform-validation:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Download terraform plans
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          pattern: "*_terraform_plan"
          path: terraform_plans/
          merge-multiple: true

      - name: Check terraform plans exist
        id: check_terraform_plans
        run: |
          if [ ! -d terraform_plans ] || [ -z "$(ls -A terraform_plans/)" ]; then
            echo "terraform_plans_exist=false" >> "$GITHUB_OUTPUT"
          else
            echo "terraform_plans_exist=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Init cfn-guard
        if: steps.check_terraform_plans.outputs.terraform_plans_exist == 'true'
        run: |
          rm -rf /tmp/ruleset cfn_guard_output
          wget -q -O /tmp/ruleset.zip https://github.com/aws-cloudformation/aws-guard-rules-registry/releases/download/1.0.2/ruleset-build-v1.0.2.zip
          unzip -q /tmp/ruleset.zip -d /tmp/ruleset/
          curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/aws-cloudformation/cloudformation-guard/main/install-guard.sh | sh
          mkdir -p cfn_guard_output

      - name: Run cfn-guard for Terraform
        if: steps.check_terraform_plans.outputs.terraform_plans_exist == 'true'
        run: |
          declare -a rulesets=("ncsc" "ncsc-cafv3" "wa-Reliability-Pillar" "wa-Security-Pillar")
          for ruleset in "${rulesets[@]}"; do
            ~/.guard/bin/cfn-guard validate \
                --data terraform_plans \
                --rules "/tmp/ruleset/output/$ruleset.guard" \
                --show-summary fail \
                > "cfn_guard_output/terraform_plans_$ruleset.txt"
          done

      - name: Show cfn-guard output
        if: failure()
        run: find cfn_guard_output -type f -print0 | xargs -0 cat

      - name: Upload cfn_guard_output
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: cfn_guard_output_terraform
          path: cfn_guard_output

  # SonarQube analysis (runs only when token exists, ~3-5 minutes)
  sonarqube-scan:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        if: ${{ inputs.install_java }}
        with:
          java-version: "21"
          distribution: "corretto"

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Check if SONAR_TOKEN exists
        id: check_sonar
        env:
          super_secret: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -n "$super_secret" ] && [ "${{ inputs.run_sonar }}" = "true" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if project uses Java
        if: steps.check_sonar.outputs.should_run == 'true'
        id: check_java
        run: |
          if [ -f pom.xml ]; then
            echo "uses_java=true" >> "$GITHUB_OUTPUT"
          else
            echo "uses_java=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run SonarQube analysis (Maven)
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'true'
        run: mvn sonar:sonar -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Install asdf
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        uses: asdf-vm/actions/setup@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}

      - name: Cache asdf
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.asdf
          key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}
          restore-keys: |
            ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}-${{ inputs.asdfVersion }}

      - name: Install asdf dependencies
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_version: ${{ inputs.asdfVersion }}
        env:
          PYTHON_CONFIGURE_OPTS: --enable-shared

      - name: Reinstall poetry
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false' && inputs.reinstall_poetry
        run: |
          poetry_tool_version=$(grep poetry .tool-versions)
          poetry_version=${poetry_tool_version//"poetry "}
          asdf uninstall poetry "$poetry_version"
          asdf install poetry

      - name: Setting up .npmrc
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
          echo "@nhsdigital:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: make install
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        run: make install

      - name: Run unit tests for coverage
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        run: make test

      - name: SonarCloud Scan
        if: steps.check_sonar.outputs.should_run == 'true' && steps.check_java.outputs.uses_java == 'false'
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
