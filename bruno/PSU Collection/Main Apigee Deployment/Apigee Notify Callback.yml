info:
  name: Apigee Notify Callback
  type: http
  seq: 3

http:
  method: POST
  url: https://{{host}}/prescription-status-update/notification-delivery-status-callback
  headers:
    - name: x-request-id
      value: "{{$guid}}"
    - name: x-correlation-id
      value: "{{$guid}}"
    - name: apikey
      value: "{{NOTIFY_API_KEY}}"
      disabled: true
  body:
    type: json
    data: "{\r

      \  \"data\": [\r

      \    {\r

      \      \"type\": \"MessageStatus\",\r

      \      \"attributes\": {\r

      \        \"messageId\": \"{{messageID}}\",\r

      \        \"messageReference\": \"REF-ABC-123\",\r

      \        \"messageStatus\": \"delivered\",\r

      \        \"messageStatusDescription\": \"Message has been delivered\",\r

      \        \"channels\": [\r

      \          {\r

      \            \"type\": \"nhsapp\",\r

      \            \"channelStatus\": \"delivered\"\r

      \          }\r

      \        ],\r

      \        \"timestamp\": \"{{$isoTimestamp}}\",\r

      \        \"routingPlan\": {\r

      \          \"id\": \"example-plan\",\r

      \          \"name\": \"Example Template\",\r

      \          \"version\": \"v1.0.0\",\r

      \          \"createdDate\": \"2025-01-01T12:00:00Z\"\r

      \        }\r

      \      },\r

      \      \"links\": {\r

      \        \"message\": \"https://api.nhs.example.com/messages/{{messageID}}\"\r

      \      },\r

      \      \"meta\": {\r

      \        \"idempotencyKey\": \"idemp-001-abc\"\r

      \      }\r

      \    }\r

      \  ]\r

      }\r\n"
  auth:
    type: apikey
    key: apikey
    value: "{{NOTIFY_API_KEY}}"
    placement: header

runtime:
  scripts:
    - type: before-request
      code: "// const crypto = pm.require('npm:crypto-js@4.2.0')\r

        \r

        const appName = bru.getEnvVar(\"NOTIFY_APP_NAME\");\r

        const apiKey  = bru.getEnvVar(\"NOTIFY_API_KEY\");\r

        \r

        if (!appName || !apiKey) {\r

        \  console.error(\"Missing APP_NAME or API_KEY in environment!\");\r

        }\r

        \r

        const secret = `${appName}.${apiKey}`;\r

        \r

        let body = \"\";\r

        const raw = req.getBody().raw;\r

        body = bru.interpolate(raw);\r

        // need to make sure the body is synced later\r

        req.getBody() = body\r

        \r

        const signature = crypto.HmacSHA256(body, secret).toString(crypto.enc.Hex);\r

        \r

        // Expects both the siganture and the api key. The app name is secret?\r

        req.getHeaders().upsert({\r

        \  key: \"x-hmac-sha256-signature\",\r

        \  value: signature\r

        });"

settings:
  encodeUrl: true
  timeout: 0
  followRedirects: true
  maxRedirects: 5
